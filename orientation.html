<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="css/reset.css">
<title>3D ミシン</title>
<style>
body{
	background-image: url('img/back_red.png');
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="debug-box">
	<!--<span id="beta-value">0</span><br><br>-->
	<!--<span id="gamma-value">0</span><br><br>-->
	<!--<span id="pointer-value">0</span><br><br>-->
	r:<span id="r-value">0</span><br><br>
	g:<span id="g-value">0</span><br><br>
	b:<span id="b-value">0</span><br><br>
	a:<span id="a-value">0</span><br><br>
</div>
<script src="js/jquery-1.11.0.min.js"></script>
<!-- <script src="js/main.js"></script> -->
<script>
$(function(){
	
	// TODO: 難易度の設定
	
	var canvas = document.getElementById("canvas");
	canvas.style.width = window.innerWidth + 'px';
	canvas.style.height = window.innerHeight + 'px';
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	var ctx = canvas.getContext("2d");
	
	var rangeImagePath = "https://preview.c9users.io/naokigt/mishin-3d/img/ginger_cookie.png";
	
	// var backImage = new Image();
 //   backImage.src = 'img/back_red.png';
 //   backImage.onload = function(){
 //       ctx.beginPath();
 //       var pattern = ctx.createPattern(backImage, 'repeat');
 //       ctx.fillStyle = pattern;
 //       ctx.rect(0, 0, canvas.width, canvas.height);
 //       ctx.fill();
 //   }
        drawingImage(rangeImagePath);

	var pointer = {
		x: 110,
		y: 90
	};
	
    
	var beta,
		gamma;
		
	// ジャイロセンサーの値が変化
	window.addEventListener("deviceorientation", function deviceorientationHandler(event) {
		beta = event.beta;
		gamma = event.gamma
	});
	

	
	
	// 範囲画像の描画
	function drawingImage(path){
		var img = new Image();
	 	img.onload = function() {
		 	var imageWidth = window.innerWidth;
		 	var imageHeight = (img.height * (imageWidth / img.width));
		  	ctx.drawImage(img, imageWidth*0.05, imageHeight*0.05, imageWidth*0.9, imageHeight*0.9);
	 	}
	 	img.src = path;
	};

	// 糸の描画
	function drawing(){
		beta = Math.floor(beta / 3 * 2);
		gamma = Math.floor(gamma / 3 * 2);

		var lineLengthX = Math.floor(gamma / 3);
		var lineLengthY = Math.floor(beta / 3);

	    pointer.x = pointer.x + gamma;
	    pointer.y = pointer.y + beta;
	    
	    if(pointer.x > canvas.width){
	    	pointer.x = canvas.width;
	    }else if(pointer.x < 0){
	    	pointer.x = 0;
	    }
	    if(pointer.y > canvas.height){
	    	pointer.y = canvas.height;
	    }else if(pointer.y < 0){
	    	pointer.y = 0;
	    }
		
		// 範囲内だけ描ける	    
	    if( ! isInRange(pointer.x, pointer.y)){
	    	return;
	    }

	    ctx.strokeStyle = "#0000ff"; //線のカラー設定
        ctx.lineWidth = 4; //線の太さ
        ctx.lineCap = "round";
        ctx.beginPath(); //パスの描画を始める
        ctx.moveTo(pointer.x, pointer.y); //線の開始位置 (xの座標値 , yの座標値)
        ctx.lineTo(pointer.x + lineLengthX, pointer.y + lineLengthY); //線の終了位置 (xの座標値, yの座標値)
        ctx.stroke(); //線の終了
	}
	
	// 範囲内だとtrue
	function isInRange(x, y){
		var imageData = ctx.getImageData(x, y, 1, 1);
    	var colorRBGA = Array.prototype.slice.apply(imageData.data);
	    $('#r-value').text(colorRBGA[0]);
	    $('#g-value').text(colorRBGA[1]);
	    $('#b-value').text(colorRBGA[2]);
	    $('#a-value').text(colorRBGA[3]);
	    
	    // 範囲外の色を指定
	    if(colorRBGA[3] == 0 || colorRBGA[0] <= 90){
	    	pointer.x -= gamma;
	    	pointer.y -= beta;
	    	return false;
	    }else{
	    	return true;
	    }
	}

	setInterval(drawing, 150);
});
</script>
</body>
</html>
